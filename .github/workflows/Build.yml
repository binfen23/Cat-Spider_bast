name: Build Custom Spider Jar & Cache

# è§¦å‘æ¡ä»¶ï¼šå¯æ ¹æ®éœ€æ±‚ä¿®æ”¹ï¼ˆå¦‚ push åˆ° main åˆ†æ”¯ã€tag å‘å¸ƒç­‰ï¼‰
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # æ”¯æŒæ‰‹åŠ¨è§¦å‘

jobs:
  build-jar:
    runs-on: ubuntu-latest  # é€‰ç”¨ Ubuntu ç¯å¢ƒï¼ˆå‘½ä»¤å…¼å®¹æ€§å¥½ã€é€Ÿåº¦å¿«ï¼‰
    steps:
      # æ­¥éª¤1ï¼šæ£€å‡ºä»“åº“ä»£ç 
      - name: Checkout code
        uses: actions/checkout@v4

      # æ­¥éª¤2ï¼šé…ç½® Java ç¯å¢ƒï¼ˆapktool ä¾èµ– Java è¿è¡Œï¼‰
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'  # é€‚é…å¤§å¤šæ•° Android é¡¹ç›®ï¼Œå¯æ ¹æ®ä½ çš„é¡¹ç›®è°ƒæ•´
          distribution: 'temurin'
          cache: gradle  # ç¼“å­˜ Gradle ä¾èµ–ï¼ˆåŠ é€Ÿæ„å»ºï¼‰

      # æ­¥éª¤3ï¼šåˆ›å»º 3rd ç›®å½•å¹¶ä¸‹è½½ apktool 2.11.0ï¼ˆå¤åˆ»åŸè„šæœ¬çš„ä¾èµ–ï¼‰
      - name: Prepare apktool 2.11.0
        run: |
          mkdir -p ./jar/3rd  # é€’å½’åˆ›å»º 3rd ç›®å½•
          # ä¸‹è½½ apktoolï¼ˆéªŒè¯è¿‡é“¾æ¥æœ‰æ•ˆï¼Œè‹¥å¤±æ•ˆå¯æ›¿æ¢ä¸ºå®˜æ–¹æœ€æ–°ä¸‹è½½åœ°å€ï¼‰
          wget -O ./jar/3rd/apktool_2.11.0.jar \
            https://bitbucket.org/iBotPeaches/apktool/downloads/apktool_2.11.0.jar
          # éªŒè¯ä¸‹è½½æ˜¯å¦æˆåŠŸ
          if [ ! -f "./jar/3rd/apktool_2.11.0.jar" ]; then
            echo "apktool ä¸‹è½½å¤±è´¥ï¼"
            exit 1
          fi

      # æ­¥éª¤4ï¼šæ„å»º Release APKï¼ˆå…³é”®ï¼åŸè„šæœ¬ä¾èµ– app-release-unsigned.apkï¼‰
      # ğŸ‘‰ è‹¥ä½ çš„é¡¹ç›®ä¸æ˜¯ Gradle æ„å»ºï¼ˆå¦‚ Mavenï¼‰ï¼Œè¯·æ›¿æ¢ä¸ºå¯¹åº”çš„æ„å»ºå‘½ä»¤
      - name: Build Release APK
        run: ./gradlew assembleRelease
        working-directory: .  # è‹¥é¡¹ç›®æ ¹ç›®å½•ä¸æ˜¯ Gradle æ ¹ç›®å½•ï¼Œéœ€è°ƒæ•´è·¯å¾„
        env:
          # ç¦ç”¨ Gradle å®ˆæŠ¤è¿›ç¨‹ï¼ˆåŠ é€Ÿ CI ç¯å¢ƒæ„å»ºï¼‰
          GRADLE_OPTS: "-Dorg.gradle.daemon=false"

      # æ­¥éª¤5ï¼šå¤åˆ»åŸ bat è„šæœ¬çš„æ ¸å¿ƒé€»è¾‘ï¼ˆWindows å‘½ä»¤ â†’ Linux å‘½ä»¤è½¬æ¢ï¼‰
      - name: Execute jar build logic
        run: |
          # 1. åˆ é™¤æ—§æ–‡ä»¶/ç›®å½•
          rm -f ./jar/custom_spider.jar
          rm -rf ./jar/Smali_classes

          # 2. åç¼–è¯‘ APKï¼ˆä»…ä¿ç•™ä¸»ç±»ï¼‰
          java -jar ./jar/3rd/apktool_2.11.0.jar \
            d -f --only-main-classes \
            ./app/build/outputs/apk/release/app-release-unsigned.apk \
            -o ./jar/Smali_classes

          # 3. åˆ é™¤ç›®æ ‡ç›®å½•æ—§æ–‡ä»¶
          rm -rf ./jar/spider.jar/smali/com/github/catvod/spider
          rm -rf ./jar/spider.jar/smali/com/github/catvod/js
          rm -rf ./jar/spider.jar/smali/org/slf4j

          # 4. åˆ›å»ºå¿…è¦ç›®å½•ï¼ˆé€’å½’åˆ›å»ºï¼Œå¿½ç•¥å·²å­˜åœ¨ï¼‰
          mkdir -p ./jar/spider.jar/smali/com/github/catvod/
          mkdir -p ./jar/spider.jar/smali/org/slf4j/

          # 5. ç§»åŠ¨ smali æ–‡ä»¶
          mv ./jar/Smali_classes/smali/com/github/catvod/spider \
             ./jar/spider.jar/smali/com/github/catvod/
          mv ./jar/Smali_classes/smali/com/github/catvod/js \
             ./jar/spider.jar/smali/com/github/catvod/
          mv ./jar/Smali_classes/smali/org/slf4j \
             ./jar/spider.jar/smali/org/

          # 6. æ‰“åŒ…ç”Ÿæˆ dex.jar
          java -jar ./jar/3rd/apktool_2.11.0.jar \
            b ./jar/spider.jar -c

          # 7. é‡å‘½åä¸º custom_spider.jar
          mv ./jar/spider.jar/dist/dex.jar ./jar/custom_spider.jar

          # 8. ç”Ÿæˆ MD5 æ–‡ä»¶ï¼ˆLinux æ›¿ä»£ Windows çš„ certUtilï¼‰
          md5sum ./jar/custom_spider.jar | awk '{print $1}' > ./jar/custom_spider.jar.md5

          # 9. æ¸…ç†ä¸´æ—¶ç›®å½•
          rm -rf ./jar/spider.jar/build
          rm -rf ./jar/spider.jar/smali
          rm -rf ./jar/spider.jar/dist
          rm -rf ./jar/Smali_classes

          # éªŒè¯äº§ç‰©æ˜¯å¦ç”ŸæˆæˆåŠŸ
          if [ ! -f "./jar/custom_spider.jar" ] || [ ! -f "./jar/custom_spider.jar.md5" ]; then
            echo "jar æˆ– md5 æ–‡ä»¶ç”Ÿæˆå¤±è´¥ï¼"
            exit 1
          fi
          echo "Jar æ„å»ºå®Œæˆï¼š"
          ls -lh ./jar/custom_spider.jar*

      # æ­¥éª¤6ï¼šç¼“å­˜ç”Ÿæˆçš„ Jar å’Œ MD5 æ–‡ä»¶ï¼ˆæ ¸å¿ƒéœ€æ±‚ï¼‰
      - name: Cache custom_spider.jar & MD5
        uses: actions/cache@v3
        with:
          # è¦ç¼“å­˜çš„æ–‡ä»¶è·¯å¾„ï¼ˆä¸ç”Ÿæˆè·¯å¾„ä¸€è‡´ï¼‰
          path: |
            ./jar/custom_spider.jar
            ./jar/custom_spider.jar.md5
          # ç¼“å­˜ Keyï¼šç”¨ Commit SHA ç¡®ä¿ç¼“å­˜ä¸ä»£ç ç‰ˆæœ¬ç»‘å®šï¼ˆé¿å…æ—§ç¼“å­˜å†²çªï¼‰
          key: ${{ github.sha }}-custom-spider-jar
          # æ¢å¤ç­–ç•¥ï¼šä¼˜å…ˆä½¿ç”¨å½“å‰ Commit çš„ç¼“å­˜ï¼Œæ— åˆ™ä¸æ¢å¤ï¼ˆå¯æ ¹æ®éœ€æ±‚è°ƒæ•´ï¼‰
          restore-keys: |
            ${{ github.sha }}-custom-spider-jar
