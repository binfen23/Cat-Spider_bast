name: Build Custom Spider Jar & Cache

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # 支持手动触发

jobs:
  build-jar:
    runs-on: ubuntu-latest
    steps:
      # 步骤1：检出仓库代码（会自动拉取 jar/3rd 目录下的已有文件）
      - name: Checkout code
        uses: actions/checkout@v4

      # 步骤2：配置 Java 环境（适配 AGP 8.13 + Java 17）
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle  # 缓存 Gradle 依赖，加速构建

      # 步骤3：构建 Release APK（修复权限问题 + 依赖刷新优化）
      - name: Build Release APK
        run: bash gradlew assembleRelease --refresh-dependencies --rerun-tasks
        working-directory: .
        env:
          GRADLE_OPTS: "-Dorg.gradle.daemon=false -Dorg.gradle.jvmargs=-Xmx2g"  # 增加堆内存，避免OOM

      # 步骤4：复刻原 bat 脚本核心逻辑（Linux 适配，直接使用仓库已有 apktool）
      - name: Execute jar build logic
        run: |
          # 删除旧文件/目录
          rm -f ./jar/custom_spider.jar
          rm -rf ./jar/Smali_classes

          # 反编译 APK（仅保留主类，使用仓库已有的 apktool）
          java -jar ./jar/3rd/apktool_2.11.0.jar \
            d -f --only-main-classes \
            ./app/build/outputs/apk/release/app-release-unsigned.apk \
            -o ./jar/Smali_classes

          # 删除目标目录旧文件
          rm -rf ./jar/spider.jar/smali/com/github/catvod/spider
          rm -rf ./jar/spider.jar/smali/com/github/catvod/js
          rm -rf ./jar/spider.jar/smali/org/slf4j

          # 创建必要目录
          mkdir -p ./jar/spider.jar/smali/com/github/catvod/
          mkdir -p ./jar/spider.jar/smali/org/slf4j/

          # 移动 smali 文件
          mv ./jar/Smali_classes/smali/com/github/catvod/spider \
             ./jar/spider.jar/smali/com/github/catvod/
          mv ./jar/Smali_classes/smali/com/github/catvod/js \
             ./jar/spider.jar/smali/com/github/catvod/
          mv ./jar/Smali_classes/smali/org/slf4j \
             ./jar/spider.jar/smali/org/

          # 打包生成 dex.jar
          java -jar ./jar/3rd/apktool_2.11.0.jar \
            b ./jar/spider.jar -c

          # 重命名为 custom_spider.jar
          mv ./jar/spider.jar/dist/dex.jar ./jar/custom_spider.jar

          # 生成 MD5 文件
          md5sum ./jar/custom_spider.jar | awk '{print $1}' > ./jar/custom_spider.jar.md5

          # 清理临时目录
          rm -rf ./jar/spider.jar/build
          rm -rf ./jar/spider.jar/smali
          rm -rf ./jar/spider.jar/dist
          rm -rf ./jar/Smali_classes

          # 验证产物
          if [ ! -f "./jar/custom_spider.jar" ] || [ ! -f "./jar/custom_spider.jar.md5" ]; then
            echo "Jar 或 MD5 文件生成失败！"
            exit 1
          fi
          echo "构建成功，产物信息："
          ls -lh ./jar/custom_spider.jar*

      # 步骤5：缓存生成的 Jar 和 MD5
      - name: Cache custom_spider.jar & MD5
        uses: actions/cache@v3
        with:
          path: |
            ./jar/custom_spider.jar
            ./jar/custom_spider.jar.md5
          key: ${{ github.sha }}-custom-spider-jar
          restore-keys: |
            ${{ github.sha }}-custom-spider-jar
